<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ”è€çˆ¹æ±‰å ¡åº—ğŸ”</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          sans: ['Nunito', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: '#FF6B35',
            secondary: '#FFD166',
            tomato: '#E63946',
            lettuce: '#2A9D8F',
            dark: '#2B2B2B',
          },
          boxShadow: {
            'game': '0 4px 0 rgba(0,0,0,0.2)',
            'game-active': '0 2px 0 rgba(0,0,0,0.2)',
          }
        }
      }
    }
  </script>

  <style>
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    :root{
      --bg:#f7f2e9; --panel:#fff; --ink:#2b2b2b; --muted:#777;
      --pri:#ff7a00; --pri2:#ffad60; --good:#22aa66; --bad:#e74c3c; --gold:#e1b200;
    }
    *{box-sizing:border-box; user-select: none;}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Nunito', system-ui, -apple-system, sans-serif;
      color:var(--ink);
      background:
        linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)),
        url("background.jpg" )no-repeat center center fixed;
      background-size:100% 100%;
      overflow-x: hidden;
    }

    header{position:sticky;top:0;background:rgba(255,255,255,0.9);backdrop-filter:blur(6px);border-bottom:1px solid #0001; z-index: 10;}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted)}
    
    .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .tag{background:#2B2B2B; color:#fff; border-radius:12px; padding:4px 10px; font-size:13px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
    .gold{background:var(--gold); color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2);}
    
    .btn{
      border:none;border-radius:12px;padding:8px 16px;
      background:var(--pri);color:#fff;
      cursor:pointer;font-weight:800;
      box-shadow: 0 4px 0 #c45d00;
      transition: all 0.1s;
      transform: translateY(0);
    }
    .btn:active{transform:translateY(4px); box-shadow: 0 0 0 #c45d00;}
    .btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

    .row{display:grid;grid-template-columns:280px 1fr 320px;gap:14px}
    @media (max-width:1000px){ .row{grid-template-columns:1fr} }
    
    .orders, .board, .serve{
      background:var(--panel);border-radius:16px;padding:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .order-card{border:2px dashed #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; background:#fff; cursor:pointer; transition: transform 0.2s;}
    .order-card:hover { transform: scale(1.02); }
    .order-card.active{ border-style:solid; border-color:#ff7a00; background: #fff8f0; }
    .order-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .order-ing{display:flex;flex-wrap:wrap;gap:4px}
    .pill{border-radius:99px;padding:2px 8px;font-size:11px;border:1px solid #0001;background:#fafafa; color:#555;}
    .timer{font-variant-numeric:tabular-nums;font-weight:800; color: var(--tomato);}
    
    .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .tab{
      padding:8px 16px;border-radius:12px;border:2px solid transparent;background:#f0f0f0;cursor:pointer;
      font-weight: 700; color: #666; transition: all 0.2s;
    }
    .tab:hover { background: #e5e5e5; }
    .tab.on{background:var(--secondary); color:#5d4037; box-shadow: 0 3px 0 #e0b040; transform: translateY(-2px);}
    
    .station{display:none; animation: fadeIn 0.3s ease;}
    .station.on{display:block}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}
    .card{
      border:2px solid #f0f0f0;border-radius:14px;background:#fff;padding:10px;text-align:center;
      box-shadow:0 4px 10px rgba(0,0,0,0.03);
      transition: all 0.2s;
    }
    .card:hover { border-color: var(--pri2); }
    
    .plate{
      margin-top:8px;height:280px;border-radius:14px;
      border:3px dashed #ddd; display:flex;
      align-items:flex-end;justify-content:center;
      background:repeating-linear-gradient(45deg,#fafafa,#fafafa 10px,#f4f4f4 10px,#f4f4f4 20px);
    }
    .stack{position:relative;width:220px;min-height:44px;display:flex;flex-direction:column-reverse;align-items:center;gap:-5px;padding-bottom:10px}
    
    .score{font-size:32px;font-weight:900; color: var(--pri);}
    .log{max-height:280px;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px;background:#f9f9f9}
    .line{font-size:12px;color:#555;margin:4px 0; border-bottom: 1px dashed #eee; padding-bottom: 2px;}

    .ing{
      padding:6px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);
      display:inline-flex;gap:6px;align-items:center;background:#fff;
      font-weight: 700; font-size: 13px;
      box-shadow: 0 2px 0 rgba(0,0,0,0.1);
    }
    .i-bun-top{background:#f8d28c; border-color: #e0b060;}
    .i-bun-bot{background:#efc577; border-color: #d0a050;}
    .i-patty{background:#7c4736;color:#fff; border-color: #5c3020;}
    .i-cheese{background:#ffd63c; border-color: #e0c030;}
    .i-lettuce{background:#b5e27b; border-color: #95c060;}
    .i-tomato{background:#ff8a8a; border-color: #e07070;}
    .i-onion{background:#e8d7ff; border-color: #c0b0e0;}
    .i-pickle{background:#a6e388; border-color: #80c060;}
    .i-sauce{background:#ffe4c4; border-color: #e0c0a0;}
    
    .drag{cursor:grab}
    .drag:active{cursor:grabbing; transform: scale(0.95);}
    
    .bar{height:12px;background:#eee;border-radius:99px;overflow:hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ecc71,#f1c40f,#e67e22,#e74c3c); transition: width 0.3s ease;}

    .grill-progress {
      height:12px; background:#eee; border-radius:99px; overflow:hidden; margin:8px 0;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .grill-progress > span {
      display:block; height:100%; transition: width 0.1s linear, background 0.3s;
    }
    
    .grill-btn {
      font-size: 12px; padding: 4px 8px; border-radius: 8px; cursor: pointer;
      border: 1px solid #ddd; background: #fff; box-shadow: 0 2px 0 #ddd;
    }
    .grill-btn:active { transform: translateY(2px); box-shadow: none; }
    .hint{font-size:12px;color:var(--muted)}

    /* --- è§†è§‰ç‰¹æ•ˆ CSS --- */
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
    }
    .float-text {
      position: fixed; pointer-events: none; z-index: 10000;
      font-weight: 900; font-size: 24px;
      text-shadow: 2px 2px 0px #fff;
      animation: floatUp 1s ease-out forwards;
    }
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-screen { animation: shake 0.5s; }

    /* --- å•†åº— CSS --- */
    .shop-card {
        border: 2px solid #f0f0f0; border-radius: 12px;
        padding: 10px;
        background: #fff; text-align: center; transition: all 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
        height: 100%;
        position: relative; 
    }
    .shop-card h3 { font-size: 16px; margin: 4px 0; }
    .shop-card p { font-size: 12px; line-height: 1.2; min-height: 30px; color: #666; }
    .shop-card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); border-color: #FF6B35; }
    .shop-card.owned { border-color: #22c55e; background: #f0fdf4; opacity: 0.9; }
    .shop-icon { font-size: 32px; margin-bottom: 4px; display: inline-block; }

    
    .order-conter{
      position:fixed;
      bottom:30px;
      right:30px;
      z-index: 5;
      width:300px;
      height:auto;
    }
    .oeder-conter-img{
      width:100%;
      height:auto;
    }
    .cashier{
      position:fixed;
      bottom:40px;
      right:40px;
      z-index: 4;
      width:200px;
      height:auto;
    }
    .cashier-img{
      width:100%;
      height:auto;
      transform:scaleX(-1);
    }
        .grill-btn:active { transform: translateY(2px); box-shadow: none; }
    .hint{font-size:12px;color:var(--muted)}

    /* --- å›¢é˜Ÿæˆå‘˜å±•ç¤ºæ ·å¼ --- */
.team-display {
  background: var(--panel);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.05);
  margin-top: 20px;
  width: 100%;
  grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰åˆ— */
}

.team-display h3 {
  font-size: 18px;
  font-weight: 900;
  color: #333;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* å…³é”®ä¿®æ”¹ï¼šç¡®ä¿æ°´å¹³æ’åˆ—ï¼Œæ¯æ’3ä¸ª */
#teamGrid {
  display: grid !important;
  grid-template-columns: repeat(3, 1fr) !important;
  gap: 16px;
  width: 100%;
  margin: 0 auto;
}

/* å›¢é˜Ÿæˆå‘˜å¡ç‰‡æ ·å¼ */
.team-member-card {
  border: 2px solid #f0f0f0;
  border-radius: 14px;
  padding: 16px;
  background: #fff;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  height: 100%;
  min-height: 180px;
  box-sizing: border-box;
}

.team-member-card.owned {
  border-color: #22c55e;
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}

.team-member-image {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 50%;
  margin-bottom: 12px;
  border: 3px solid #22c55e;
}

.team-member-name {
  font-weight: 800;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
  width: 100%;
  word-break: keep-all;
}

.team-member-desc {
  font-size: 12px;
  color: #666;
  line-height: 1.3;
  margin-bottom: 8px;
  width: 100%;
  min-height: 16px;
}

.team-member-skill {
  font-size: 11px;
  background: #22c55e;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 700;
  margin-top: auto;
  display: inline-block;
  white-space: nowrap;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  #teamGrid {
    grid-template-columns: repeat(3, 1fr) !important;
  }
}

@media (max-width: 768px) {
  #teamGrid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  .team-member-card {
    min-height: 170px;
    padding: 14px;
  }
}

@media (max-width: 480px) {
  #teamGrid {
    grid-template-columns: 1fr !important;
  }
  
  .team-display {
    padding: 16px;
  }
}
/* ä¿®å¤å•†åº—æŒ‰é’®å†…å›¾æ ‡å’Œæ–‡å­—å¯¹é½é—®é¢˜ */
#btnOpenShop {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
}

/* ç¡®ä¿å›¾æ ‡å‚ç›´å±…ä¸­ */
#btnOpenShop .iconify {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    vertical-align: middle !important;
}
    /* --- è§†è§‰ç‰¹æ•ˆ CSS --- */
    
    </style>
</head>

<body class="bg-orange-50 p-8 flex flex-wrap justify-center min-h-screen">

  <div id="shopTooltip" class="fixed z-[100] pointer-events-none transition-opacity duration-200 opacity-0 bg-gray-900/95 text-white p-4 rounded-xl shadow-2xl border border-white/10 max-w-[280px] backdrop-blur-sm" style="left:0; top:0;">
      <div id="tipTitle" class="font-black text-lg text-secondary mb-1"></div>
      <div id="tipSkill" class="text-xs font-bold text-primary mb-2 bg-orange-900/30 px-2 py-1 rounded inline-block"></div>
      <div id="tipEffect" class="text-sm font-bold mb-2 leading-snug"></div>
      <div id="tipFlavor" class="text-xs text-gray-400 italic border-t border-gray-700 pt-2 mt-2"></div>
  </div>

  <div id="audio-controls" style="display:none;">
    <audio id="bgm-start" loop autoplay><source src="start.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-game" loop><source src="game.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-end" ><source src="end.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-shop" loop><source src="shop.mp3" type="audio/mpeg"></audio>
  </div>
  
  <div id="click-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(5px);">
    <div style="background:#fff; padding:20px 40px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.2); text-align:center; animation: bounce 1s infinite alternate;">
      <span class="iconify" data-icon="mdi:hand-pointing-up" style="font-size:40px; color:#FF6B35;"></span>
      <h3 style="margin:10px 0 0; color:#333; font-weight:900;">ç‚¹å‡»å±å¹•å¼€å¯å£°éŸ³</h3>
    </div>
  </div>

  <div id="startPage" class="w-[375px] md:w-[500px] lg:w-[600px] h-auto bg-white rounded-3xl border-4 border-orange-200 shadow-2xl m-4 relative overflow-hidden transform hover:scale-[1.01] transition-transform duration-500">
    <div class="h-24 bg-gradient-to-r from-primary to-orange-400 flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/food.png')] opacity-20"></div>
        <h1 class="text-4xl font-black text-white drop-shadow-md tracking-wider">Papa's Burgeria</h1>
    </div>
    <div class="flex flex-col items-center p-8 relative">
      <div class="w-56 md:w-64 mx-auto mt-4 mb-8">
        <img id="1" class="w-full h-auto drop-shadow-xl hover:rotate-3 transition-transform duration-300"
             src="./è€çˆ¹å›¾ç‰‡/laodie.gif"
             onerror="this.src='https://cdn-icons-png.flaticon.com/512/3075/3075977.png'" 
             alt="Chef character" />
      </div>
      <button id="startGameBtn" class="w-64 h-16 bg-primary hover:bg-orange-600 rounded-2xl text-white text-2xl font-black mb-6 shadow-game hover:translate-y-[-2px] active:translate-y-[2px] active:shadow-none transition-all flex items-center justify-center gap-2">
        <span class="iconify" data-icon="mdi:play" data-width="32"></span> å¼€å§‹æ¸¸æˆ
      </button>
      <button id="showInstruction" class="w-52 h-12 bg-secondary hover:bg-yellow-400 rounded-xl text-orange-900 font-bold mb-4 shadow-game-active active:translate-y-[2px] active:shadow-none transition-all flex items-center justify-center gap-2">
        <span class="iconify" data-icon="mdi:book-open-page-variant" data-width="20"></span> æ¸¸æˆè¯´æ˜
      </button>
    </div>
    <div class="bg-orange-50 p-3 text-center border-t border-orange-100">
        <p class="text-orange-300 text-xs font-bold">Â© 2025 Papa's Burgeria Remastered</p>
    </div>

    <div id="instructionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" style="display:none;">
      <div class="bg-white rounded-3xl border-4 border-orange-300 shadow-2xl w-[90%] md:w-[500px] max-h-[80vh] relative overflow-hidden animate-[fadeIn_0.3s_ease-out]">
        <button id="closeInstruction" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-red-100 hover:bg-red-200 text-red-500 flex items-center justify-center transition-all z-10">
          <span class="iconify" data-icon="mdi:close" data-width="20"></span>
        </button>
        <div class="h-16 bg-secondary flex items-center justify-center">
          <h3 class="text-xl font-black text-orange-900 flex items-center gap-2"><span class="iconify" data-icon="mdi:school" data-width="24"></span> æ–°æ‰‹æ•™ç¨‹</h3>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(80vh-64px)] space-y-4">
            <div class="flex gap-3 p-4 bg-orange-50 rounded-xl border border-orange-100">
              <div class="bg-white p-2 rounded-lg h-fit shadow-sm"><span class="iconify text-primary" data-icon="mdi:grill" data-width="24"></span></div>
              <div><strong class="text-primary block mb-1">1. çƒ¤è‚‰å°</strong><span class="text-sm text-gray-600 leading-relaxed">ç‚¹å‡»ã€ä¸‹è‚‰é¥¼ã€‘ï¼Œè§‚å¯ŸæŒ‡é’ˆã€‚<br><span class="text-blue-500 font-bold">è“è‰²</span>=ç”Ÿï¼Œ<span class="text-green-500 font-bold">ç»¿è‰²</span>=ç¿»é¢ï¼Œ<span class="text-orange-500 font-bold">æ©™è‰²</span>=ç†Ÿã€‚</span></div>
            </div>
            <div class="flex gap-3 p-4 bg-orange-50 rounded-xl border border-orange-100">
              <div class="bg-white p-2 rounded-lg h-fit shadow-sm"><span class="iconify text-primary" data-icon="mdi:hamburger" data-width="24"></span></div>
              <div><strong class="text-primary block mb-1">2. ç»„è£…å°</strong><span class="text-sm text-gray-600 leading-relaxed">å¿…é¡»ï¼š<span class="bg-yellow-200 px-1 rounded">é¢åŒ…åº•</span> â†’ é£Ÿæ â†’ <span class="bg-yellow-200 px-1 rounded">é¢åŒ…é¡¶</span>ã€‚</span></div>
            </div>
            <div class="flex gap-3 p-4 bg-orange-50 rounded-xl border border-orange-100">
              <div class="bg-white p-2 rounded-lg h-fit shadow-sm"><span class="iconify text-primary" data-icon="mdi:alarm" data-width="24"></span></div>
              <div><strong class="text-primary block mb-1">3. æ—¶é—´ä¸è¯„åˆ†</strong><span class="text-sm text-gray-600 leading-relaxed">è¥ä¸šæ—¶é—´ä¸ºåŠ¨æ€è®¡ç®—ï¼Œå°½å¯èƒ½å¤šåœ°å®Œæˆè®¢å•ï¼</span></div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div id="shopPage" class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50" style="display:none;">
    <div class="bg-white rounded-3xl border-4 border-orange-300 shadow-2xl w-[90%] md:w-[700px] h-auto max-h-[90vh] relative overflow-hidden flex flex-col animate-[fadeIn_0.3s_ease-out]">
        <div class="bg-primary p-4 flex justify-between items-center shrink-0">
            <h2 class="text-2xl font-black text-white flex items-center gap-2">
                <span class="iconify" data-icon="mdi:account-group"></span> å›¢é˜Ÿå•†åº—
            </h2>
            <div class="bg-black/20 rounded-full px-4 py-1 text-white font-bold flex items-center gap-1">
                <span class="iconify" data-icon="mdi:currency-usd"></span> <span id="shopCoins">0</span>
            </div>
        </div>
        <div class="p-6 overflow-y-auto grow bg-orange-50">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="shopGrid"></div>
        </div>
        <div class="p-4 bg-white border-t border-orange-100 flex justify-center shrink-0">
            <button id="closeShopBtn" class="btn bg-gray-600 hover:bg-gray-700 w-full md:w-auto min-w-[200px]">è¿”å›ç»“ç®—</button>
        </div>
    </div>
  </div>

  <div id="gamePage" style="display:none; width:100%;">
    <header>
      <div class="wrap">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-3">
             <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white">
                <span class="iconify" data-icon="mdi:chef-hat" data-width="24"></span>
             </div>
             <div>
                <h1 class="text-gray-800">è€çˆ¹æ±‰å ¡åº— <span class="text-primary text-sm bg-orange-100 px-2 py-0.5 rounded-full">è¥ä¸šä¸­</span></h1>
                <div class="sub">æ‹–æ‹½é£Ÿæï¼Œå®Œç¾å¤åˆ»è®¢å•ï¼</div>
             </div>
          </div>
          <div class="hud">
            <span class="tag gold flex items-center gap-1"><span class="iconify" data-icon="mdi:currency-usd"></span> <b id="coins">0</b></span>
            <span class="tag bg-orange-600 flex items-center gap-1"><span class="iconify" data-icon="mdi:fire"></span> <b id="combo">0</b>x</span>
            <span class="tag bg-blue-500 flex items-center gap-1"><span class="iconify" data-icon="mdi:calendar-blank"></span> ç¬¬ <b id="day">1</b> å¤©</span>
            
            <button id="btnNextDay" class="btn bg-green-500 hover:bg-green-600 shadow-[0_4px_0_#15803d] active:shadow-none active:translate-y-[4px]">å¼€å§‹è¥ä¸š</button>
            <button id="btnEndDay" class="btn bg-gray-700 hover:bg-gray-800 shadow-[0_4px_0_#1f2937] active:shadow-none active:translate-y-[4px]">ä»Šæ—¥ç»“ç®—</button>
          </div>
        </div>
      </div>
    </header>

    <main class="wrap" style="margin-top:20px">
      <div class="row">
        <section class="orders">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
            <h3 class="font-black text-lg flex items-center gap-2"><span class="iconify text-primary" data-icon="mdi:receipt-text"></span> è®¢å•é˜Ÿåˆ—</h3>
            <span class="hint bg-gray-100 px-2 py-1 rounded">æ— é™æ¥å•æ¨¡å¼</span>
          </div>
          <div id="orderList" class="min-h-[100px] max-h-[500px] overflow-y-auto pr-1">
             <div class="text-center text-gray-300 py-8 text-sm">ç­‰å¾…æ–°é¡¾å®¢ï¼Œç‚¹å‡»ä¸Šæ–¹â€œå¼€å§‹â€</div>
          </div>
        </section>

        <section class="board">
          <div class="tabs">
            <button class="tab on" data-tab="grill">â‘  çƒ¤è‚‰å°</button>
            <button class="tab" data-tab="build">â‘¡ ç»„è£…å°</button>
            <div class="order-conter">
              <img src="table.png" alt="ç‚¹é¤å°" class="order-conter-image">
            </div>
            <div class="cashier">
              <img src="./è€çˆ¹å›¾ç‰‡/laodie.gif" alt="æ”¶é“¶å‘˜" class="cashier-img">
            </div>
          </div>

          <div class="station on" id="grill">
            <div class="grid" id="grillGrid"></div>
            <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 mt-4 flex items-center gap-3">
               <span class="iconify text-primary text-2xl" data-icon="mdi:information"></span>
               <div class="text-xs text-gray-600">
                  <span class="font-bold text-primary">æŠ€å·§ï¼š</span> ç»¿è‰²åŒºåŸŸç¿»é¢ï¼Œé‡‘è‰²åŒºåŸŸèµ·é”…ã€‚
                  <br>å®Œç¾æ—¶é—´ï¼š<b class="text-green-600">7.0ï½8.5</b> ç§’ã€‚
               </div>
            </div>
          </div>

          <div class="station" id="build">
            <div class="grid" id="ingPool" style="margin-bottom:16px"></div>
            <div class="plate shadow-inner">
              <div id="stack" class="stack"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:16px">
              <div class="hint text-gray-400">â† æ‹–æ‹½é£Ÿæå †å </div>
              <div class="right flex gap-2">
                <button id="btnClear" class="tab text-red-500 hover:bg-red-50 hover:text-red-600">
                    <span class="iconify inline mb-1" data-icon="mdi:trash-can-outline"></span> æ¸…ç©º
                </button>
                <button id="btnServe" class="btn flex items-center gap-2 pl-4 pr-4">
                    å‡ºé¤ <span class="iconify" data-icon="mdi:bell-ring"></span>
                </button>
              </div>
            </div>
          </div>
        </section>
        <section class="serve">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <h3 class="font-black text-lg">â­ æœ¬å•è¯„åˆ†</h3>
            <span class="small bg-gray-100 px-2 py-1 rounded text-gray-500">å€’è®¡æ—¶: <b id="levelTimer" class="text-red-600 text-lg">180</b>s</span>
          </div>
          
          <div class="text-center py-4 bg-gray-50 rounded-xl mb-4 border border-gray-100">
             <div class="score" id="score">0</div>
             <div class="text-xs text-gray-400 uppercase tracking-widest font-bold">Score</div>
          </div>
          
          <div class="bar mb-2"><span id="scoreBar" style="width:0%"></span></div>
          <div class="small text-center text-gray-500 mb-4" id="detail">ç­‰å¾…å‡ºé¤...</div>

          <h4 class="font-bold text-sm text-gray-400 border-b border-gray-100 pb-2 mb-2">ğŸ“œ å†å²è®°å½•</h4>
          <div class="log hide-scrollbar" id="log"></div>
        </section>
         <!-- åœ¨è¿™é‡Œæ·»åŠ å›¢é˜Ÿå±•ç¤º -->
        <section class="team-display">
          <h3 class="font-black text-lg flex items-center gap-2 mb-4">
            <span class="iconify text-primary" data-icon="mdi:account-group"></span> å›¢é˜Ÿæˆå‘˜
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="teamGrid">
            <!-- è¿™é‡Œä¼šåŠ¨æ€æ˜¾ç¤ºå·²æ‹›å‹Ÿçš„å›¢é˜Ÿæˆå‘˜ -->
          </div>
        </section>

   

        
      </div>
    </main>
  </div>

  <div id="endPage" class="w-[375px] md:w-[600px] lg:w-[800px] h-auto bg-white rounded-3xl border-4 border-orange-200 shadow-2xl m-4 relative overflow-hidden animate-[fadeIn_0.5s_ease-out]" style="display:none;">
    <div class="h-28 flex items-center justify-center relative bg-gradient-to-r from-orange-50 to-white overflow-hidden">
      <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-30"></div>
      <div class="z-10 text-center">
          <h2 class="text-3xl md:text-4xl font-black text-primary drop-shadow-sm">ä»Šæ—¥è¥ä¸šç»“æŸ</h2>
          <div class="h-1.5 w-24 bg-primary rounded-full mx-auto mt-2"></div>
      </div>
    </div>
    <div class="px-6 md:px-12 py-6 overflow-y-auto hide-scrollbar">
      <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-6 shadow-sm border border-orange-100 mb-6">
        <div class="grid grid-cols-2 gap-6">
          <div class="bg-white rounded-xl p-4 border border-orange-100 shadow-sm flex flex-col items-center justify-center">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2"><span class="iconify text-blue-500" data-icon="mdi:account-group" data-width="28"></span></div>
            <div class="text-4xl font-black text-gray-800" id="endCustomers">0</div>
            <div class="text-sm font-bold text-gray-400 mt-1">æ€»æœåŠ¡é¡¾å®¢æ•°</div>
          </div>
          <div class="bg-white rounded-xl p-4 border border-orange-100 shadow-sm flex flex-col items-center justify-center">
            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-2"><span class="iconify text-yellow-600" data-icon="mdi:currency-usd" data-width="28"></span></div>
            <div class="text-4xl font-black text-gray-800" id="endCoins">$0</div>
            <div class="text-sm font-bold text-gray-400 mt-1">æ€»æ”¶å…¥</div>
          </div>
        </div>
        <div class="mt-6">
          <div class="flex justify-between mb-2">
            <span class="text-sm font-bold text-gray-600">é¡¾å®¢æ»¡æ„åº¦</span>
            <span class="text-sm font-bold text-primary" id="endSatisfaction">0%</span>
          </div>
          <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden shadow-inner">
            <div class="h-full bg-gradient-to-r from-primary to-yellow-400 rounded-full transition-all duration-1000 ease-out" id="endSatisfactionBar" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-4 mb-2">
        <button id="btnOpenShop" class="h-16 bg-blue-500 hover:bg-blue-600 rounded-2xl font-black text-white text-lg shadow-game-active hover:-translate-y-1 transition-all flex items-center justify-center gap-2" style="display: none;">
          <span class="iconify" data-icon="mdi:shopping" data-width="24"></span> å•†åº—
        </button>
        <button id="btnContinue" class="col-span-2 h-16 bg-secondary hover:bg-yellow-400 rounded-2xl font-black text-orange-900 text-lg shadow-game-active hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
          <span class="iconify" data-icon="mdi:play-circle" data-width="24"></span> ç»§ç»­ä¸‹ä¸€å¤©
        </button>
      </div>
      <div class="mt-4 flex justify-center">
          <button id="btnExit" class="text-gray-400 hover:text-tomato text-sm font-bold flex items-center gap-1 transition-colors">
            <span class="iconify" data-icon="mdi:exit-to-app" data-width="16"></span> é‡ç½®æ¸¸æˆ
          </button>
      </div>
    </div>
    <div class="bg-gray-50 border-t border-gray-100 p-4 text-center">
      <p class="text-primary font-bold mb-1" id="endMessage">åšå¾—ä¸é”™ï¼</p>
    </div>
  </div>

  <script>
    const INGREDIENTS = [
      ["bun-bottom","é¢åŒ…åº•","i-bun-bot","ğŸ«“", true],
      ["patty","ç‰›è‚‰é¥¼","i-patty","ğŸ¥©", false],
      ["cheese","èŠå£«","i-cheese","ğŸ§€", false],
      ["lettuce","ç”Ÿèœ","i-lettuce","ğŸ¥¬", false],
      ["tomato","ç•ªèŒ„","i-tomato","ğŸ…", false],
      ["onion","æ´‹è‘±","i-onion","ğŸ§…", false],
      ["pickle","é…¸é»„ç“œ","i-pickle","ğŸ¥’", false],
      ["sauce","é…±æ–™","i-sauce","ğŸ§‚", false],
      ["bun-top","é¢åŒ…é¡¶","i-bun-top","ğŸ", true],
    ];

    const COOK_IDEAL = [7.0, 8.5];
    let COOK_MAX = 12.0; 
    const QUEUE_MAX = 99; 
    
    const BASE_ORDER_TIME = 15; 
    const EXTRA_DAY_TIME = 5;  
// å¼ºåˆ¶è®¾ç½®ç¬¬0å¤©æ˜¾ç¤º
function setDayZero() {
    day = 1;
    updateHUD(); // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
}
    let day = 0, coins = 0, combo = 0;
    let isShopOpen = false;
    let levelTimeLeft = 0; 
    let levelTimerInterval = null;
    let SLOTS = 6; 
    // æ·»åŠ ç¼“å†²æœŸç›¸å…³å˜é‡
let isBufferPeriod = false; // æ˜¯å¦å¤„äºç¼“å†²æœŸ
let bufferTimer = 0; // ç¼“å†²æœŸå€’è®¡æ—¶ï¼ˆç§’ï¼‰ï¼Œè®¾ä¸º0åˆ™ä¸ºæ‰‹åŠ¨å¼€å§‹
    // ä»·æ ¼å·²å¤§å¹…é™ä½ï¼ŒDay 3 å¯è´­ä¹°
    let upgrades = {
        tianyurong: { 
            id: 'tianyurong', name: 'ç”œèŠ‹ç»’', 
            desc: 'å¿ƒæ€æ‹…å½“',
            skill: 'æŠ€èƒ½ï¼šç”œç¾æ²»æ„ˆ',
            effect: 'æ•ˆæœï¼šé¡¾å®¢è€å¿ƒå€¼å¢åŠ  20% (é¡¾å®¢æ›´ä¸å®¹æ˜“ç”Ÿæ°”)ã€‚',
            flavor: 'â€œç”œèŠ‹ç»’çš„å£°éŸ³å¤ªæ¸©æŸ”äº†ï¼Œé¡¾å®¢å…‰æ˜¯å¬ç€å°±ä¸èˆå¾—ç”Ÿæ°”èµ°äººã€‚â€',
            price: 30, owned: false, icon: 'mdi:heart-multiple' 
        },
        wanjiang: { 
            id: 'wanjiang', name: 'ä¸¸é…±', 
            desc: 'é˜²å®ˆæ‹…å½“',
            skill: 'æŠ€èƒ½ï¼šæŠ¤è‚‰ä½¿è€…',
            effect: 'æ•ˆæœï¼šè‚‰é¥¼çƒ¤ç³Šçš„æ—¶é—´åˆ¤å®šå»¶é•¿ 50% (æ‰‹æ®‹å…šæ•‘æ˜Ÿ)ã€‚',
            flavor: 'â€œä¸¸é…±å·å·ç»™è‚‰é¥¼åˆ·äº†ä¸€å±‚ç§˜åˆ¶é…±æ–™ï¼Œæ€ä¹ˆçƒ¤éƒ½ä¸å®¹æ˜“ç³Šï¼â€',
            price: 40, owned: false, icon: 'mdi:shield-check' 
        },
        cuiyuankao: { 
            id: 'cuiyuankao', name: 'è„†åœ†çƒ¤', 
            desc: 'ç«åŠ›æ‹…å½“',
            skill: 'æŠ€èƒ½ï¼šæ€¥æ€¥å›½ç‹',
            effect: 'æ•ˆæœï¼šçƒ¤è‚‰é€Ÿåº¦æå‡ 25% (è‚‰ç†Ÿå¾—æ›´å¿«ï¼Œé€‚åˆé«˜æ‰‹åˆ·å•)ã€‚',
            flavor: 'â€œå«Œç«å¤ªå°ï¼Ÿè„†åœ†çƒ¤ç›´æ¥æŠŠç‚‰ç¶ç«åŠ›è°ƒåˆ°äº†æœ€å¤§ï¼â€',
            price: 50, owned: false, icon: 'mdi:fire' 
        },
        luoke: { 
            id: 'luoke', name: 'æ´›å¯', 
            desc: 'ç®¡ç†æ‹…å½“',
            skill: 'æŠ€èƒ½ï¼šç©ºé—´ç®¡ç†å¤§å¸ˆ',
            effect: 'æ•ˆæœï¼šçƒ¤è‚‰ä½ä» 6 ä¸ªå¢åŠ åˆ° 8 ä¸ªã€‚',
            flavor: 'â€œæ´›å¯é‡æ–°è§„åˆ’äº†å¨æˆ¿å¸ƒå±€ï¼Œç°åœ¨èƒ½åŒæ—¶çƒ¤æ›´å¤šè‚‰äº†ï¼â€',
            price: 60, owned: false, icon: 'mdi:view-grid-plus' 
        },
        maoyuxia: { 
            id: 'maoyuxia', name: 'çŒ«é±¼è™¾', 
            desc: 'æ‹›è´¢æ‹…å½“',
            skill: 'æŠ€èƒ½ï¼šæ‹›è´¢çŒ«ä½“è´¨',
            effect: 'æ•ˆæœï¼šæ‰€æœ‰è®¢å•ç»“ç®—æ—¶ï¼Œå°è´¹é¢å¤–å¢åŠ  20%ã€‚',
            flavor: 'â€œè‡ªå¸¦å¸é‡‘å…‰ç¯ï¼Œåªè¦ä»–åœ¨åº—é‡Œï¼Œé¡¾å®¢ç»™é’±éƒ½å˜å¤§æ–¹äº†ï¼â€',
            price: 70, owned: false, icon: 'mdi:cat' 
        }
    };

    let state = {
        ordersToSpawn: 0,
        ordersSpawned: 0,
        orderSchedulerTimeout: null 
    };

    const bgmStart = document.getElementById('bgm-start');
    const bgmGame = document.getElementById('bgm-game');
    const bgmEnd = document.getElementById('bgm-end');
    const bgmShop = document.getElementById('bgm-shop'); 

    // BGM æ§åˆ¶
    function playMusic(scene) {
        [bgmStart, bgmGame, bgmEnd, bgmShop].forEach(audio => {
            if(audio) { audio.pause(); audio.currentTime = 0; }
        });
        let target = null;
        if(scene === 'start') target = bgmStart;
        if(scene === 'game') target = bgmGame;
        if(scene === 'end') target = bgmEnd;
        if(scene === 'shop') target = bgmShop; 
        
        if(target) {
            target.volume = 0.4;
            target.play().catch(e => console.log("éœ€äº¤äº’æ’­æ”¾éŸ³ä¹"));
        }
    }

    let dayStats = {
      customersServed: 0,
      totalCoins: 0,
      satisfactionRate: 0,
    };

    let grill = new Array(SLOTS).fill(null); 
    let lastFrame = performance.now();

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function rnd(a,b){ return Math.random()*(b-a)+a }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]}
    function formatSecs(x){ return (Math.round(x*10)/10).toFixed(1) }

    function screenShake() {
        document.body.classList.add('shake-screen');
        setTimeout(() => document.body.classList.remove('shake-screen'), 500);
    }

    function showFloatingText(x, y, text, color="#22c55e") {
        const el = document.createElement("div");
        el.className = "float-text";
        el.textContent = text;
        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

   function genOrder(){
      const doublePattyChance = Math.min(0.8, Math.max(0, (day - 3) * 0.15));
      const patties = Math.random() < doublePattyChance ? 2 : 1;
      
      const wants = ["bun-bottom"];
      const layersPool = ["cheese","lettuce","tomato","onion","pickle","sauce"];
      
      const minLayers = Math.min(2, 1 + Math.floor(day / 5)); 
      const maxLayers = Math.min(6, 3 + Math.floor(day / 3));
      const layerCount = Math.floor(rnd(minLayers, maxLayers + 0.9));
      
      for(let i=0;i<layerCount;i++) wants.push(choice(layersPool));
      for(let i=0;i<patties;i++){
        const pos = Math.max(1, Math.floor(rnd(1, wants.length)));
        wants.splice(pos,0,"patty");
      }
      wants.push("bun-top");
      
      const targetCook = choice(["ä¸‰åˆ†åç”Ÿ","äº”åˆ†é€‚ä¸­","ä¸ƒåˆ†åç†Ÿ"]);
      
      let minTime = Math.max(25, 30 - day); 
      let maxTime = Math.max(40, 55 - day);
      
      if(upgrades.tianyurong.owned) {
          minTime *= 1.2;
          maxTime *= 1.2;
      }
      
      return {
        id: Math.random().toString(36).slice(2,8).toUpperCase(),
        wants,
        targetCook,
        timeLimit: Math.floor(rnd(minTime, maxTime)),
        born: performance.now()
      }
  }


    function cookScore(tSec, target){
      const [L,R] = COOK_IDEAL;
      let l=L, r=R;
      if(target.includes("ä¸‰åˆ†")){ l=L-1; r=L+0.5 }
      if(target.includes("äº”åˆ†")){ l=L;   r=R }
      if(target.includes("ä¸ƒåˆ†")){ l=R-0.5; r=R+1 }
      const center=(l+r)/2, w=(r-l)/2;
      const dist = Math.abs(tSec-center);
      let s = Math.max(0, 1 - dist/(w*2));
      if(tSec > COOK_MAX) s = 0;
      return s;
    }

    function structureScore(need, got){
      const n=need.length, m=got.length;
      if(m===0) return 0;
      const lenScore = Math.max(0, 1 - Math.abs(n-m)/n);
      let match=0;
      for(let i=0;i<Math.min(n,m);i++){
        if(need[i]===got[i]) match++;
      }
      const orderScore = match/Math.max(n,m);
      const hardFail = !(got.includes("bun-bottom") && got.includes("bun-top"));
      return hardFail ? 0.1*orderScore*lenScore : 0.5*orderScore + 0.5*lenScore;
    }
    
    function scheduleNextOrder(delayMs) {
        if (state.ordersSpawned >= state.ordersToSpawn) return;
        if (state.orderSchedulerTimeout) clearTimeout(state.orderSchedulerTimeout);

        state.orderSchedulerTimeout = setTimeout(() => {
            pushOrder();
        }, delayMs);
    }

    const orderList = $("#orderList");
    let orders = [];
    let activeOrderIdx = 0;
    
    function pushOrder(){
        if (state.ordersSpawned >= state.ordersToSpawn) return;
        
        const o = genOrder();
        orders.push(o);
        renderOrders();
        state.ordersSpawned++;
        
        toast(`ğŸ”” æ–°è®¢å• #${o.id} æ¥äº†ï¼`);

        if (state.ordersSpawned < state.ordersToSpawn) {
            const speedFactor = Math.min(3000, day * 300); 
            let nextDelay = Math.max(2000, 6000 - speedFactor);
            nextDelay = rnd(nextDelay * 0.8, nextDelay * 1.2);
            scheduleNextOrder(nextDelay);
        }
    }

    function renderOrders(){
      if(!orderList) return;
      if(orders.length === 0) {
        orderList.innerHTML = `<div class="text-center text-gray-400 py-6 text-sm italic">ç­‰å¾…æ–°é¡¾å®¢...</div>`;
        return;
      }
      orderList.innerHTML = orders.map((o,idx)=>{
        const pills = o.wants.map(w=>`<span class="pill">${labelOf(w)}</span>`).join("");
        const left = Math.max(0, o.timeLimit - Math.floor((performance.now()-o.born)/1000));
        return `
          <div class="order-card ${idx===activeOrderIdx?'active':''}" data-oid="${o.id}" data-idx="${idx}">
            <div class="order-top">
              <div class="text-sm"><b>#${o.id}</b> <span class="text-xs text-gray-500">(${o.targetCook})</span></div>
              <div class="timer ${left < 10 ? 'text-red-600 animate-pulse':''}">â± ${left}s</div>
            </div>
            <div class="order-ing">${pills}</div>
          </div>
        `
      }).join("");
    }

    if(orderList){
      orderList.addEventListener('click', (e)=>{
        const card = e.target.closest('.order-card');
        if(!card) return;
        activeOrderIdx = Math.min(orders.length-1, Math.max(0, +card.dataset.idx));
        renderOrders();
      });
    }

    function labelOf(id){
      const m = INGREDIENTS.find(x=>x[0]===id);
      return m ? m[3] : id;
    }

    setInterval(()=>{
      if(orders.length > 0){
        orders = orders.filter(o=>{
          const left = o.timeLimit - Math.floor((performance.now()-o.born)/1000);
          if(left<=0){
            logLine(`âŒ è®¢å• #${o.id} ç”Ÿæ°”èµ°äººäº†ï¼ˆ-5 é‡‘å¸ï¼‰`);
            coins = Math.max(0, coins-5);
            combo = 0;
            screenShake();
            showFloatingText(window.innerWidth/2, window.innerHeight/2, "- $5", "#ef4444");
            updateHUD();
            return false;
          }
          return true;
        });
        if(activeOrderIdx >= orders.length) activeOrderIdx = Math.max(0, orders.length-1);
        renderOrders();
      }
    }, 500);

    const grillGrid = $("#grillGrid");
    let grillElements = []; 
    let lastRenderTime = 0;
    const RENDER_INTERVAL = 100; 

    function handlePutPatty(idx) {
      if(!isShopOpen) {
        toast("ğŸš§ ç°åœ¨è¿˜æ²¡æœ‰è¥ä¸š å¿«ç‚¹å¼€å§‹å§", "warning");
        return;
      }
      if(!grill[idx]) {
        grill[idx] = {state:"cooking", t:0};
        toast(`ğŸ– çƒ¤ç›˜${idx+1}æ”¾å…¥è‚‰é¥¼`);
        updateGrillSlot(idx);
      } else {
        toast(`âŒ çƒ¤ç›˜${idx+1}å·²æœ‰è‚‰é¥¼`);
      }
    }

    function handleFlipPatty(idx) {
      if(grill[idx]?.state==="cooking") {
        grill[idx].state="flipped";
        toast(`ğŸ”„ çƒ¤ç›˜${idx+1}è‚‰é¥¼ç¿»é¢`);
        updateGrillSlot(idx);
      }
    }

    function handleDonePatty(idx) {
      if(grill[idx] && (grill[idx].state==="flipped"||grill[idx].state==="done")) {
        addCooked(grill[idx].t);
        grill[idx] = null;
        toast(`âœ… çƒ¤ç›˜${idx+1}è‚‰é¥¼å‡ºé”…`);
        updateGrillSlot(idx);
      }
    }

    function handleDumpPatty(idx) {
      grill[idx] = null;
      toast(`ğŸ—‘ çƒ¤ç›˜${idx+1}è‚‰é¥¼ä¸¢å¼ƒ`);
      updateGrillSlot(idx);
    }

    function initGrill(){
      if(!grillGrid) return;
      grillGrid.innerHTML = "";
      
      if(upgrades.luoke.owned) {
          SLOTS = 8;
      } else {
          SLOTS = 6;
      }
      
      if(grill.length !== SLOTS) {
          grill = new Array(SLOTS).fill(null);
      }
      
      grillElements = new Array(SLOTS).fill(null);

      for(let i=0; i<SLOTS; i++) {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.slot = i;
        grillGrid.appendChild(card);
        grillElements[i] = card;
        updateGrillSlot(i);
      }
    }

    function updateGrillSlot(idx) {
      const card = grillElements[idx];
      if(!card) return;
      
      const g = grill[idx];
      let bar="0%", txt="<span class='text-gray-300'>ç©ºé—²</span>", btnA, btnB;
      let barColor = "#2ecc71";

      if(g){
        const t = g.t;
        const pct = Math.min(100, Math.round(t/COOK_MAX*100));
        bar = pct+"%";
        
        if(t < COOK_IDEAL[0]) barColor = "#3b82f6";
        else if(t <= COOK_IDEAL[1]) barColor = "#22c55e";
        else if(t <= COOK_MAX) barColor = "#eab308";
        else barColor = "#ef4444";
        
        txt = `<span style="color:${barColor}; font-weight:bold;">${g.state==="cooking"?"ç…çƒ¤ä¸­":g.state==="flipped"?"ç¬¬2é¢":g.state==="done"?"å®Œç¾":"ç³Šäº†"}</span> Â· ${formatSecs(t)}s`;

        if(g.state==="cooking") {
          btnA = `<button class="tab grill-btn hover:bg-blue-50 text-blue-600 border-blue-200" data-action="flip">ç¿»é¢</button>`;
        } else if(g.state==="flipped" || g.state==="done") {
          btnA = `<button class="btn grill-btn bg-green-500 text-white border-none shadow-sm hover:bg-green-600" data-action="done">èµ·é”…</button>`;
        } else {
          btnA = `<button class="tab ghost" disabled>â€”</button>`;
        }
        btnB = `<button class="tab grill-btn text-red-400 hover:text-red-600 hover:bg-red-50" data-action="dump">ä¸¢</button>`;
      } else {
        btnA = `<button class="tab grill-btn hover:bg-orange-50 text-primary border-orange-200 font-bold" data-action="put">ä¸‹è‚‰é¥¼</button>`;
        btnB = ``;
      }

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:6px;">
          <b class="text-sm">#${idx+1}</b>
          <span class="small text-xs">${txt}</span>
        </div>
        <div class="grill-progress"><span style="width:${bar};background:${barColor}"></span></div>
        <div style="display:flex;gap:4px;justify-content:flex-end; margin-top:8px;">${btnA}${btnB}</div>
      `;

      const buttons = card.querySelectorAll(".grill-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.dataset.action;
          switch(action) {
            case "put": handlePutPatty(idx); break;
            case "flip": handleFlipPatty(idx); break;
            case "done": handleDonePatty(idx); break;
            case "dump": handleDumpPatty(idx); break;
          }
        });
      });
    }

    function tick(now){
      const dt = (now - lastFrame)/1000;
      lastFrame = now;
      
      if(upgrades.wanjiang.owned) {
          COOK_MAX = 18.0; 
      } else {
          COOK_MAX = 12.0;
      }
      
      let speedMultiplier = upgrades.cuiyuankao.owned ? 1.25 : 1.0;

      let needsUpdate = false;
      for(let i=0;i<SLOTS;i++){
        if(grill[i]){
          grill[i].t += dt * speedMultiplier; 
          needsUpdate = true;
          if(grill[i].t > COOK_MAX && grill[i].state !== "burnt"){
            grill[i].state = "burnt";
            updateGrillSlot(i);
            screenShake();
            toast("ğŸ”¥ ç³Ÿç³•ï¼è‚‰çƒ¤ç³Šäº†ï¼", "warning");
          }else if(grill[i].state === "flipped" && grill[i].t >= COOK_IDEAL[0] && grill[i].t <= COOK_IDEAL[1]){
            grill[i].state = "done";
            updateGrillSlot(i);
          }
        }
      }

      if(needsUpdate && now - lastRenderTime > RENDER_INTERVAL) {
        for(let i=0;i<SLOTS;i++){
          if(grill[i] && grillElements[i]) {
            const g = grill[i];
            const progressBar = grillElements[i].querySelector('.grill-progress span');
            const textSpan = grillElements[i].querySelector('.small');
            if(progressBar) {
               const pct = Math.min(100, Math.round(g.t/COOK_MAX*100));
               let barColor = "#3b82f6";
               if(g.t >= COOK_IDEAL[0] && g.t <= COOK_IDEAL[1]) barColor = "#22c55e";
               else if(g.t > COOK_IDEAL[1] && g.t <= COOK_MAX) barColor = "#eab308";
               else if(g.t > COOK_MAX) barColor = "#ef4444";

               progressBar.style.width = pct + "%";
               progressBar.style.background = barColor;
            }
            if(textSpan) {
                textSpan.innerHTML = `<span style="font-weight:bold;">${g.state==="cooking"?"ç…çƒ¤ä¸­":g.state==="flipped"?"ç¬¬2é¢":g.state==="done"?"å®Œç¾":"ç³Šäº†"}</span> Â· ${formatSecs(g.t)}s`;
            }
          }
        }
        lastRenderTime = now;
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    let cookedBuff = [];
    function addCooked(t){
      cookedBuff.push({tSec:t});
      toast(`âœ… å‡ºé”…ï¼š${formatSecs(t)}s è‚‰é¥¼`);
      renderPool();
    }

    const ingPool = $("#ingPool");
    const stack = $("#stack");

    function ingHTML(id){
      const d = INGREDIENTS.find(x=>x[0]===id);
      return `<div class="ing drag ${d[2]} hover:scale-105 transition-transform" draggable="true" data-id="${id}">${d[3]} ${d[1]}</div>`;
    }

    function renderPool(){
      if(!ingPool) return;
      const basics = ["bun-bottom","cheese","lettuce","tomato","onion","pickle","sauce","bun-top"];
      const cooked = cookedBuff.map((c,i)=>`<div class="ing drag i-patty hover:scale-105 transition-transform" draggable="true" data-id="patty" data-cook="${c.tSec}">ğŸ¥© ç‰›è‚‰é¥¼ <span class="small ml-1 text-xs opacity-80">(${formatSecs(c.tSec)}s)</span></div>`);
      ingPool.innerHTML = [...basics.map(ingHTML), ...cooked].map(x=>`<div class="flex justify-center">${x}</div>`).join("");
    }
    renderPool();

    let dragData=null;
    document.addEventListener("dragstart",(e)=>{
      const el = e.target.closest(".drag"); if(!el) return;
      dragData = { id:el.dataset.id, cook: el.dataset.cook? +el.dataset.cook : null, srcEl:el };
    });
    if(stack){
      stack.addEventListener("dragover", e=> e.preventDefault());
      stack.addEventListener("drop", e=>{
        e.preventDefault(); if(!dragData) return;
        addToStack(dragData.id, dragData.cook ?? null);
        dragData=null;
      });
      stack.addEventListener("click", (e)=>{
        const el = e.target.closest(".ing");
        if(!el) return;
        removeFromStack(el);
      });
    }

    if(ingPool){
      ingPool.addEventListener("click", (e)=>{
        const el = e.target.closest(".drag");
        if(!el) return;
        addToStack(el.dataset.id, el.dataset.cook? +el.dataset.cook : null);
      });
    }

    function classOf(id){ return (INGREDIENTS.find(x=>x[0]===id)||[])[2] || "" }
    function nameOf(id){ return (INGREDIENTS.find(x=>x[0]===id)||[])[1] || id }
    function emojiOf(id){ return (INGREDIENTS.find(x=>x[0]===id)||[])[3] || "ğŸ”" }

    function addToStack(id, cook){
      if(!stack) return;
      if(id!=="bun-bottom" && !stack.querySelector('[data-id="bun-bottom"]')){
        toast("ğŸ‘‡ è¯·å…ˆæ”¾å…¥é¢åŒ…åº•");
        return;
      }
      if(id==="bun-top" && stack.querySelector('[data-id="bun-top"]')){
        toast("âš ï¸ é¢åŒ…é¡¶åªèƒ½ä¸€ä¸ª");
        return;
      }
      
      const node = document.createElement("div");
      node.className = `ing removable ${classOf(id)} animate-[fadeIn_0.2s_ease-out] cursor-pointer hover:brightness-110`;
      node.dataset.id = id;
      node.innerHTML = `${emojiOf(id)} ${nameOf(id)} ${cook?`<span class="small ml-1">(${formatSecs(cook)}s)</span>`:""}`;
      stack.appendChild(node);

      if(id==="patty" && cook!=null){
        const k=cookedBuff.findIndex(x=>Math.abs(x.tSec-cook)<1e-6);
        if(k>=0) cookedBuff.splice(k,1);
        renderPool();
      }
    }

    function removeFromStack(el){
      el.remove();
    }

    const btnClear = $("#btnClear");
    if(btnClear && stack){
      btnClear.addEventListener("click", ()=>{
        stack.innerHTML="";
      });
    }

    const scoreEl = $("#score"), scoreBar=$("#scoreBar"), detail=$("#detail"), logEl=$("#log");

    if($("#btnServe")){
      $("#btnServe").addEventListener("click", (e)=>{
        if(orders.length===0){ toast("ğŸ‘» æš‚æ— è®¢å•ï½"); return; }
        const cur = orders[activeOrderIdx];
        if(!stack){ toast("è¯·å…ˆç»„è£…æ±‰å ¡"); return; }
        const got = Array.from(stack.querySelectorAll(".ing")).map(el=>el.dataset.id);

        if(!got.includes("bun-bottom")){ toast("ğŸ éœ€è¦é¢åŒ…åº•"); return; }
        if(!got.includes("bun-top")){ toast("ğŸ éœ€è¦é¢åŒ…é¡¶"); return; }
        if(!got.includes("patty")){ toast("ğŸ¥© éœ€è¦è‡³å°‘ä¸€ä¸ªç‰›è‚‰é¥¼"); return; }

        const sStruct = structureScore(cur.wants, got);
        const patties=Array.from(stack.querySelectorAll('.ing[data-id="patty"]'))
          .map(el=>{
            const m = el.textContent.match(/\(([\d.]+)s\)/);
            return m ? +m[1] : 0;
          });
        const target = cur.targetCook;
        const cookScores = patties.map(t=>cookScore(t, target));
        const sCook = cookScores.length? (cookScores.reduce((a,b)=>a+b,0)/cookScores.length) : 0.2;
        const tUsed = Math.floor((performance.now()-cur.born)/1000);
        const speed = Math.max(0, 1 - tUsed/cur.timeLimit);

        let final = 100*(0.5*sStruct + 0.35*sCook + 0.15*speed);
        final = Math.round(final);

        if(final >= 90) {
          confetti({
              particleCount: 150,
              spread: 80,
              origin: { y: 0.6 },
              colors: ['#FF6B35', '#FFD166', '#2A9D8F'] 
            });
          toast("ğŸ‰ å®Œç¾è®¢å•ï¼å¤ªç¥äº†ï¼", "warning"); 
        } else if (final < 50) {
            screenShake();
        }

        let gain = Math.round(final/15);
        if(final>=80){ combo++; gain += combo; }
        else if(final>=60){ combo = Math.max(0, combo); }
        else combo = 0;
        
        if(upgrades.maoyuxia.owned) {
            gain = Math.round(gain * 1.2);
        }

        coins += gain;
        
        if(e && e.clientX) {
             showFloatingText(e.clientX, e.clientY - 50, `+ $${gain}`, "#eab308");
        }

        dayStats.customersServed++;
        dayStats.totalCoins = coins;
        dayStats.satisfactionRate = Math.min(100, Math.round((dayStats.customersServed / (dayStats.customersServed + 2)) * 100 + (final/10)));
        
        updateHUD();

        if(scoreEl) scoreEl.textContent = final;
        if(scoreBar){
          scoreBar.style.width = Math.min(100, final)+"%";
          scoreBar.style.background = final>=80 ? "#22c55e" : final>=60 ? "#eab308" : "#ef4444";
        }
        if(detail){
            detail.innerHTML = `
             <div class="grid grid-cols-3 gap-2 text-sm mt-2">
                <div>ç»“æ„ <b>${Math.round(sStruct*100)}</b></div>
                <div>ç†Ÿåº¦ <b>${Math.round(sCook*100)}</b></div>
                <div>é€Ÿåº¦ <b>${Math.round(speed*100)}</b></div>
             </div>
             <div class="mt-2 text-primary font-bold">+${gain} é‡‘å¸</div>
            `;
        }
        logLine(`ğŸ’° #${cur.id} å¾—åˆ† ${final} (+${gain}$)`);

        if(stack) stack.innerHTML="";
        orders.splice(activeOrderIdx,1);
        activeOrderIdx = Math.max(0, activeOrderIdx-1);
        renderOrders();
      });
    }

    function updateHUD(){
      if($("#coins")) $("#coins").textContent = coins;
      if($("#combo")) $("#combo").textContent = combo;
      if($("#day")) $("#day").textContent = day;
    }
    function logLine(t){
      if(!logEl) return;
      const div=document.createElement("div");
      div.className="line";
      div.innerHTML = `<span class="text-gray-400 text-xs">[${new Date().toLocaleTimeString().slice(0,5)}]</span> ${t}`;
      logEl.prepend(div);
    }
    
    function toast(t, type="info"){
      const el=document.createElement("div");
      el.innerHTML = t;
      const bg = type === 'warning' ? '#f59e0b' : '#333';
      el.style.cssText=`position:fixed;left:50%;top:100px;transform:translateX(-50%) translateY(10px);background:${bg};color:#fff;padding:10px 20px;border-radius:50px;z-index:9999;opacity:0;transition:all .3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2)`;
      document.body.appendChild(el);
      requestAnimationFrame(()=>{ 
          el.style.opacity=1;
          el.style.transform="translateX(-50%) translateY(0)";
      });
      setTimeout(()=>{ 
          el.style.opacity=0; 
          el.style.transform="translateX(-50%) translateY(-10px)";
          setTimeout(()=>el.remove(),300)
      }, 1500);
    }

    const btnNextDay = $("#btnNextDay");
    if(btnNextDay){
      btnNextDay.addEventListener("click", ()=>{
        startDay();
      });
    }
// æ›´æ–°è¥ä¸šçŠ¶æ€æŒ‰é’®æ˜¾ç¤º
function updateBusinessButtons() {
  const btnNextDay = document.getElementById('btnNextDay');
  const btnEndDay = document.getElementById('btnEndDay');
  
  if (!btnNextDay || !btnEndDay) return;
  
  if (isShopOpen) {
    // è¥ä¸šä¸­ï¼šæ˜¾ç¤ºç»“ç®—æŒ‰é’®ï¼Œéšè—å¼€å§‹è¥ä¸šæŒ‰é’®
    btnNextDay.style.display = 'none';
    btnEndDay.style.display = '';
  } else {
    // éè¥ä¸šä¸­ï¼šæ˜¾ç¤ºå¼€å§‹è¥ä¸šæŒ‰é’®ï¼Œéšè—ç»“ç®—æŒ‰é’®
    btnNextDay.style.display = '';
    btnEndDay.style.display = 'none';
  }
}
 function startDay(){
  
      isShopOpen = true; 
      //day++; 
  updateBusinessButtons();
  // å¦‚æœä»ç¼“å†²æœŸå¼€å§‹ï¼Œå…ˆç»“æŸç¼“å†²æœŸ
  if (isBufferPeriod) {
    isBufferPeriod = false;
    isShopOpen = true;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if(btnNextDay) btnNextDay.style.display = "none";
    if(btnEndDay) btnEndDay.style.display = "";
    
    // æ¸…ç©ºç¼“å†²æœŸæç¤º
    const orderList = document.getElementById('orderList');
    if (orderList) orderList.innerHTML = `<div class="text-center text-gray-300 py-8 text-sm">ç­‰å¾…æ–°é¡¾å®¢...</div>`;
    
    // é‡ç½®è¯„åˆ†æ˜¾ç¤º
    const detail = document.getElementById('detail');
    if(detail) detail.innerHTML = "ç­‰å¾…å‡ºé¤...";
    
    toast("ğŸ”” ç¬¬ " + day + " å¤©è¥ä¸šå¼€å§‹ï¼");
  } else {
    // åŸæœ‰é€»è¾‘ï¼ˆä»æ¸¸æˆå¼€å§‹ï¼‰
    isShopOpen = true; 
    day++;
    
    if(btnNextDay) btnNextDay.style.display = "none";
    if(btnEndDay) btnEndDay.style.display = "";
  }
      if(btnNextDay) btnNextDay.style.display = "none";
      
      orders = [];
      activeOrderIdx = 0;
      cookedBuff = [];
      
      const scoreEl = document.getElementById("score");
      const scoreBar = document.getElementById("scoreBar");
      const detailEl = document.getElementById("detail");
      const logEl = document.getElementById("log");
      
      if(scoreEl) scoreEl.textContent = "0";
      if(scoreBar) { scoreBar.style.width = "0%"; scoreBar.style.background = "#eee"; }
      if(detailEl) detailEl.innerHTML = "ç­‰å¾…å‡ºé¤...";
      if(logEl) logEl.innerHTML = ""; 
      
      updateHUD(); 

      let orderCount = 2 + day;
      levelTimeLeft = (orderCount * BASE_ORDER_TIME) + EXTRA_DAY_TIME;
      
      updateTimerDisplay();
      if(levelTimerInterval) clearInterval(levelTimerInterval);
      levelTimerInterval = setInterval(timerTick, 1000);

      state.ordersToSpawn = orderCount; 
      state.ordersSpawned = 0; 
      
      if (state.orderSchedulerTimeout) clearTimeout(state.orderSchedulerTimeout);
      
      if (orderCount > 0) {
        scheduleNextOrder(1000); 
      }
      
      renderOrders();
      initGrill(); 
      renderPool();
      
      logLine(`ğŸ“… ç¬¬ ${day} å¤©å¼€å¼ ï¼`);
      toast(`ğŸ”” ç¬¬ ${day} å¤©è¥ä¸šå¼€å§‹ï¼(é™æ—¶: ${levelTimeLeft}s)`);
      
    }

    function timerTick() {
      if(!isShopOpen) return;
      levelTimeLeft--;
      updateTimerDisplay();

      if(levelTimeLeft <= 0) {
        clearInterval(levelTimerInterval);
        if (state.orderSchedulerTimeout) clearTimeout(state.orderSchedulerTimeout);
        toast("â° è¥ä¸šæ—¶é—´åˆ°ï¼å‡†å¤‡æ‰“çƒŠï¼", "warning");
        
        setTimeout(() => {
             $("#btnEndDay").click(); 
        }, 1500);
      }
    }

    function updateTimerDisplay() {
      const el = $("#levelTimer");
      if(el) {
          el.textContent = levelTimeLeft;
          if(levelTimeLeft <= 30) el.classList.add("animate-pulse");
          else el.classList.remove("animate-pulse");
      }
    }

    $$(".tab[data-tab]").forEach(b=>{
      b.addEventListener("click", ()=>{
        $$(".tab[data-tab]").forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        const key=b.dataset.tab;
        $$(".station").forEach(s=>s.classList.remove("on"));
        const target = $("#"+key);
        if(target) target.classList.add("on");
        if(key === "grill") setTimeout(()=>initGrill(), 50);
      });
    });

    const shopPage = document.getElementById('shopPage');
    const shopGrid = document.getElementById('shopGrid');
    const shopCoins = document.getElementById('shopCoins');
    
    function updateShopUI() {
        if(!shopGrid) return;
        shopCoins.textContent = coins;
        
        shopGrid.innerHTML = Object.values(upgrades).map(u => {
            const btnClass = u.owned ? 'bg-gray-300 cursor-not-allowed' : (coins >= u.price ? 'bg-green-500 hover:bg-green-600 shadow-game-active hover:-translate-y-1' : 'bg-gray-300 cursor-not-allowed');
            const btnText = u.owned ? 'å·²æ‹›å‹Ÿ' : `æ‹›å‹Ÿ $${u.price}`;
            const clickAttr = (u.owned || coins < u.price) ? '' : `onclick="buyUpgrade('${u.id}')"`;
            
            return `
            <div class="shop-card ${u.owned ? 'owned' : ''}" 
                 onmouseenter="showTooltip(event, '${u.id}')" 
                 onmousemove="moveTooltip(event)" 
                 onmouseleave="hideTooltip()">
                <div>
                    <span class="iconify shop-icon ${u.owned?'text-green-500':'text-primary'}" data-icon="${u.icon}"></span>
                    <h3 class="font-bold text-lg text-gray-800">${u.name}</h3>
                    <p class="text-sm text-gray-500 mt-2 min-h-[30px] flex items-center justify-center">${u.desc}</p>
                </div>
                <button class="btn w-full mt-4 ${btnClass}" ${clickAttr}>${btnText}</button>
            </div>
            `;
        }).join("");
    }
    
    const shopTooltip = document.getElementById('shopTooltip');
    const tipTitle = document.getElementById('tipTitle');
    const tipSkill = document.getElementById('tipSkill');
    const tipEffect = document.getElementById('tipEffect');
    const tipFlavor = document.getElementById('tipFlavor');

    window.showTooltip = function(e, id) {
        const u = upgrades[id];
        if(!u) return;

        tipTitle.textContent = u.name;
        tipSkill.textContent = u.skill;
        tipEffect.textContent = u.effect;
        tipFlavor.textContent = u.flavor;

        shopTooltip.style.opacity = "1";
        moveTooltip(e);
    }
    
    window.moveTooltip = function(e) {
        let x = e.clientX + 20;
        let y = e.clientY + 20;
        
        if(x + 280 > window.innerWidth) x = e.clientX - 300;
        if(y + 200 > window.innerHeight) y = e.clientY - 200;
        
        shopTooltip.style.left = x + "px";
        shopTooltip.style.top = y + "px";
    }
    
    window.hideTooltip = function() {
        shopTooltip.style.opacity = "0";
    }
    
    window.buyUpgrade = function(id) {
        const u = upgrades[id];
        if(!u || u.owned || coins < u.price) return;
        
        coins -= u.price;
        u.owned = true;
        
        playMusic('game'); 
        toast(`ğŸ æˆåŠŸæ‹›å‹Ÿï¼š${u.name}`);
        updateShopUI();
        updateHUD(); 
    }

    const startPage = document.getElementById('startPage');
    const gamePage = document.getElementById('gamePage');
    const endPage = document.getElementById('endPage');

    const startGameBtn = document.getElementById('startGameBtn');
    if(startGameBtn){
      // ä¿®æ”¹startGameBtnäº‹ä»¶ç›‘å¬å™¨ä¸­çš„è°ƒç”¨

      startGameBtn.addEventListener('click', ()=>{
        startPage.style.display = 'none';
        gamePage.style.display = 'block';
        endPage.style.display = 'none';
        shopPage.style.display = 'none';
        playMusic('game'); 
        setDayOne(); // ä¿®æ”¹è¿™é‡Œï¼šä»setDayZeroæ”¹ä¸ºsetDayOne
        setTimeout(()=>{ initGrill(); }, 300);
        isShopOpen = false; 
        updateBusinessButtons();
        toast("ğŸ‘† è¯·ç‚¹å‡»ä¸Šæ–¹â€œå¼€å§‹è¥ä¸šâ€æŒ‰é’®");
});
    }
// è¿›å…¥ç¼“å†²æœŸ
function enterBufferPeriod() {
  day++;
  isBufferPeriod = true;
  
  // æ¸…ç©ºæ‰€æœ‰è®¢å•
  orders = [];
  activeOrderIdx = 0;
  cookedBuff = [];
  grill = new Array(SLOTS).fill(null);
  
  // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
  clearInterval(levelTimerInterval);
  if (state.orderSchedulerTimeout) {
    clearTimeout(state.orderSchedulerTimeout);
    state.orderSchedulerTimeout = null;
  }
  
  // é‡ç½®è®¢å•ç”ŸæˆçŠ¶æ€
  state.ordersToSpawn = 0;
  state.ordersSpawned = 0;
  
  // æ›´æ–°UI
  updateBufferUI();
  renderOrders();
  initGrill();
  renderPool();
  
  // æ˜¾ç¤ºç¼“å†²æœŸæç¤º
  toast("ğŸ“… æ–°çš„ä¸€å¤©å‡†å¤‡ä¸­... å‡†å¤‡å¥½åç‚¹å‡»'å¼€å§‹è¥ä¸š'", "warning");
   updateHUD();
}

// æ›´æ–°ç¼“å†²æœŸUI
function updateBufferUI() {
  const btnNextDay = document.getElementById('btnNextDay');
  const btnEndDay = document.getElementById('btnEndDay');
  const orderList = document.getElementById('orderList');
  
  if (isBufferPeriod) {
    // ä¿®æ”¹æŒ‰é’®æ–‡å­—å’ŒçŠ¶æ€
    if (btnNextDay) {
      btnNextDay.textContent = "å¼€å§‹è¥ä¸š";
      btnNextDay.style.display = "";
      btnNextDay.disabled = false;
      btnNextDay.classList.remove("bg-gray-400");
      btnNextDay.classList.add("bg-green-500", "hover:bg-green-600");
    }
    
    if (btnEndDay) {
      btnEndDay.style.display = "none";
    }
    
    // æ›´æ–°è®¢å•åˆ—è¡¨æ˜¾ç¤ºç¼“å†²æœŸä¿¡æ¯
    if (orderList) {
      orderList.innerHTML = `
        <div class="text-center py-8">
          <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="iconify text-blue-500 text-3xl" data-icon="mdi:coffee"></span>
          </div>
          <h3 class="text-lg font-bold text-gray-700 mb-2">è¥ä¸šå‡†å¤‡æ—¶é—´</h3>
          <p class="text-gray-500 text-sm mb-4">æ•´ç†å¨æˆ¿ï¼Œå‡†å¤‡é£Ÿæ...</p>
          <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 max-w-sm mx-auto">
            <div class="flex items-center gap-2 text-blue-700">
              <span class="iconify" data-icon="mdi:information"></span>
              <span class="text-sm">å‡†å¤‡å¥½åç‚¹å‡»ä¸Šæ–¹çš„ <span class="font-bold text-green-600">"å¼€å§‹è¥ä¸š"</span> æŒ‰é’®</span>
            </div>
          </div>
        </div>
      `;
    }
    
    // æ›´æ–°ç»„è£…å°æç¤º
    const detail = document.getElementById('detail');
    if (detail) {
      detail.innerHTML = `
        <div class="text-center text-gray-400">
          <div class="text-sm mb-1">ğŸ›‘ è¥ä¸šå‡†å¤‡ä¸­</div>
          <div class="text-xs">æ•´ç†é£Ÿæï¼Œæ£€æŸ¥è®¾å¤‡...</div>
        </div>
      `;
    }
  }
}
    const btnEndDay = document.getElementById('btnEndDay');
    if(btnEndDay){
      
      btnEndDay.addEventListener('click', ()=>{
          clearInterval(levelTimerInterval); 
    if (state.orderSchedulerTimeout)
        clearInterval(state.orderSchedulerTimeout); 
    isShopOpen = false;
    updateBusinessButtons();
    updateEndPageStats();
        
         
        enterBufferPeriod();
        
        startPage.style.display = 'none';
        gamePage.style.display = 'none';
        endPage.style.display = 'block';
        shopPage.style.display = 'none';
        playMusic('end'); 
       
      });
    }

    const btnContinue = document.getElementById('btnContinue');
if(btnContinue){
  btnContinue.addEventListener('click', ()=>{
    startPage.style.display = 'none';
    gamePage.style.display = 'block';
    endPage.style.display = 'none';
    shopPage.style.display = 'none';
    playMusic('game');
    // æ¸…ç©ºçŠ¶æ€ï¼Œä½†ä¸å¢åŠ å¤©æ•°
    orders = [];
    activeOrderIdx = 0;
    cookedBuff = [];
    grill = new Array(SLOTS).fill(null);
    isShopOpen = false;
    
    // æ›´æ–°UI
    updateBusinessButtons();
    renderOrders();
    initGrill();
    renderPool();
    
    // â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ–°æŒ‰é’®å¸ƒå±€ â˜…â˜…â˜…
    if (day >= 1) { // ç°åœ¨è¿›å…¥çš„æ˜¯ç¬¬2å¤©æˆ–ä¹‹å
        document.getElementById('btnOpenShop').style.display = 'block';
        btnContinue.className = btnContinue.className.replace('col-span-3', 'col-span-2');
    }
  });
}
    
    const btnOpenShop = document.getElementById('btnOpenShop');
    const closeShopBtn = document.getElementById('closeShopBtn');
    
    if(btnOpenShop) {
        btnOpenShop.addEventListener('click', ()=>{
            updateShopUI();
            shopPage.style.display = 'flex';
            playMusic('shop'); // æ’­æ”¾å•†åº—éŸ³ä¹
        });
    }
    if(closeShopBtn) {
        closeShopBtn.addEventListener('click', ()=>{
            shopPage.style.display = 'none';
            playMusic('end'); // å›åˆ°ç»“ç®—éŸ³ä¹
        });
    }
// â˜…â˜…â˜… æ–°å¢ï¼šå®Œå…¨é‡ç½®æ¸¸æˆå‡½æ•° â˜…â˜…â˜…
function resetGame() {
   // é‡ç½®åŸºç¡€æ•°æ®
    day = 1; // ä¿®æ”¹è¿™é‡Œï¼šä»0æ”¹ä¸º1
    coins = 0;
    combo = 0;
    isShopOpen = false;
    levelTimeLeft = 0;
    
    // é‡ç½®æ¯æ—¥ç»Ÿè®¡æ•°æ®
    dayStats = {
        customersServed: 0,
        totalCoins: 0,
        satisfactionRate: 0,
    };
    
    // é‡ç½®è®¢å•ç›¸å…³
    orders = [];
    activeOrderIdx = 0;
    cookedBuff = [];
    grill = new Array(SLOTS).fill(null);
    
    // é‡ç½®è®¢å•ç”ŸæˆçŠ¶æ€
    state = {
        ordersToSpawn: 0,
        ordersSpawned: 0,
        orderSchedulerTimeout: null 
    };
    
    // é‡ç½®æ‰€æœ‰å›¢é˜Ÿæˆå‘˜
    Object.values(upgrades).forEach(u => {
        u.owned = false;
    });
    
    // é‡ç½®æ¸¸æˆç•Œé¢
    if(stack) stack.innerHTML = "";
    if(scoreEl) scoreEl.textContent = "0";
    if(scoreBar) {
        scoreBar.style.width = "0%";
        scoreBar.style.background = "#eee";
    }
    if(detail) detail.innerHTML = "ç­‰å¾…å‡ºé¤...";
    if(logEl) logEl.innerHTML = "";
    
    // é‡ç½®è®¡æ—¶å™¨
    clearInterval(levelTimerInterval);
    levelTimerInterval = null;
    if (state.orderSchedulerTimeout) {
        clearTimeout(state.orderSchedulerTimeout);
        state.orderSchedulerTimeout = null;
    }
    
    // æ›´æ–°UI
    updateHUD();
    renderOrders();
    initGrill();
    renderPool();
    updateTeamDisplay();
    updateShopUI();
    
    // é‡ç½®ç»“æŸé¡µé¢æ˜¾ç¤º
    if($("#endCustomers")) $("#endCustomers").textContent = "0";
    if($("#endCoins")) $("#endCoins").textContent = "$0";
    if($("#endSatisfaction")) $("#endSatisfaction").textContent = "0%";
    if($("#endSatisfactionBar")) $("#endSatisfactionBar").style.width = "0%";
    
    // é‡ç½®å•†åº—æŒ‰é’®
    const btnOpenShop = document.getElementById('btnOpenShop');
    const btnContinue = document.getElementById('btnContinue');
    if(btnOpenShop) btnOpenShop.style.display = 'none';
    if(btnContinue) btnContinue.className = btnContinue.className.replace('col-span-2', 'col-span-3');
    
    // é‡ç½®æ¸¸æˆé¡µé¢æŒ‰é’®
    if(btnNextDay) btnNextDay.style.display = "";
    
    console.log("æ¸¸æˆå·²å®Œå…¨é‡ç½®");
}
    
const btnExit = $("#btnExit");
if(btnExit){
  btnExit.addEventListener('click', ()=>{
    // å…ˆå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©æ‰§è¡Œæ“ä½œ
    if(confirm("ç¡®å®šè¦é€€å‡ºæ¸¸æˆå¹¶é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ\n\næ‰€æœ‰é‡‘å¸ã€å›¢é˜Ÿæˆå‘˜å’Œè¿›åº¦éƒ½å°†è¢«æ¸…ç©ºï¼")) {
        // ç”¨æˆ·ç‚¹å‡»"ç¡®å®š"ï¼šé‡ç½®æ¸¸æˆ
        resetGame();

        // è¿”å›å¼€å§‹é¡µé¢
        startPage.style.display = 'block';
        gamePage.style.display = 'none';
        endPage.style.display = 'none';
        shopPage.style.display = 'none';
        playMusic('start');

        toast("ğŸ® æ¸¸æˆè¿›åº¦å·²æ¸…ç©ºï¼Œé‡æ–°å¼€å§‹ï¼");
    } else {
        // ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"ï¼šä»€ä¹ˆéƒ½ä¸åšï¼Œæˆ–è€…ç»™ä¸€ä¸ªæç¤º
        toast("âŒ å·²å–æ¶ˆé‡ç½®æ“ä½œ");
        // æˆ–è€…å¯ä»¥åœç•™åœ¨å½“å‰é¡µé¢
        // startPage.style.display = 'none';
        // gamePage.style.display = 'none';
        // endPage.style.display = 'block'; // ä¿æŒç»“ç®—é¡µé¢
    }
  });
}
    
    function updateEndPageStats() {
      const level = Math.floor(dayStats.totalCoins / 50) + 1;
      const levelProgress = (dayStats.totalCoins % 50) / 50 * 100;
      const nextLevelNeeded = 50 - (dayStats.totalCoins % 50);
      
      if($("#endCustomers")) $("#endCustomers").textContent = dayStats.customersServed;
      if($("#endCoins")) $("#endCoins").textContent = "$" + dayStats.totalCoins;
      if($("#endSatisfaction")) $("#endSatisfaction").textContent = dayStats.satisfactionRate + "%";

      if($("#endSatisfactionBar")) {
          $("#endSatisfactionBar").style.width = "0%";
      }
      setTimeout(() => {
          if($("#endSatisfactionBar")) {
              $("#endSatisfactionBar").style.width = dayStats.satisfactionRate + "%";
          }
      }, 300);

     // â˜…â˜…â˜… ä¿®æ”¹ï¼šç¬¬äºŒå¤©å°±æ˜¾ç¤ºå•†åº—æŒ‰é’®ï¼ˆç°åœ¨ä»ç¬¬1å¤©å¼€å§‹ï¼Œæ‰€ä»¥ç¬¬1å¤©ç»“æŸåæ˜¾ç¤ºï¼‰
    const btnOpenShop = document.getElementById('btnOpenShop');
    if (btnOpenShop) {
        if (day >= 1) { // è¿™é‡Œä¿æŒ>=1ï¼Œå› ä¸ºç°åœ¨ä»ç¬¬1å¤©å¼€å§‹
            btnOpenShop.style.display = 'block';
        } else {
            btnOpenShop.style.display = 'none';
        }
    }

// â˜…â˜…â˜… ä¿®æ”¹ï¼šè°ƒæ•´ç»§ç»­æŒ‰é’®å¸ƒå±€
    const btnContinue = document.getElementById('btnContinue');
    if (btnContinue) {
        if (day >= 1) { // è¿™é‡Œä¿æŒ>=1ï¼Œå› ä¸ºç°åœ¨ä»ç¬¬1å¤©å¼€å§‹
            btnContinue.className = btnContinue.className.replace('col-span-3', 'col-span-2');
        } else {
            btnContinue.className = btnContinue.className.replace('col-span-2', 'col-span-3');
        }
    }

let message = "åšå¾—ä¸é”™ï¼";
if(dayStats.satisfactionRate >= 90) message = "å¤ªæ£’äº†ï¼ç±³å…¶æ—ä¸‰æ˜Ÿæ°´å‡†ï¼";
else if(dayStats.satisfactionRate >= 70) message = "å¾ˆæ£’ï¼é¡¾å®¢ä»¬å¾ˆå–œæ¬¢ï¼";
else if(dayStats.customersServed < 2) message = "ç”Ÿæ„æœ‰ç‚¹å†·æ¸…ï¼Œæ˜å¤©åŠ æ²¹ï¼";

// â˜…â˜…â˜… ä¿®æ”¹ï¼šç¬¬ä¸€å¤©æç¤ºè¯­ â˜…â˜…â˜…
if (day === 1) {
    message += " å•†åº—å·²å¼€æ”¾ï¼";
}

if($("#endMessage")) $("#endMessage").textContent = message;
    }

    window.addEventListener('load', ()=>{
          initGrill();
          
          const overlay = document.getElementById('click-overlay');
          const startAudio = document.getElementById('bgm-start');

          function startAudioContext() {
              if(startAudio) {
                  startAudio.volume = 0.5;
                  startAudio.play().catch(e => console.log("æ’­æ”¾å¤±è´¥", e));
              }
              if(overlay) {
                  overlay.style.transition = "opacity 0.3s";
                  overlay.style.opacity = "0";
                  setTimeout(() => overlay.remove(), 300);
              }
          }

          if(overlay) {
              overlay.addEventListener('click', startAudioContext);
          }
          
          document.body.addEventListener('click', () => {
              if(startAudio && startAudio.paused) {
                  startAudioContext();
              }
          }, { once: true });
        });
    document.body.addEventListener('click', ()=>{
        if(startPage.style.display !== 'none' && bgmStart.paused) {
            playMusic('start');
        }
    }, {once:true});

    const instructionModal = document.getElementById('instructionModal')
    const showInstruction = document.getElementById('showInstruction')
    const closeInstruction = document.getElementById('closeInstruction')

    if(showInstruction) showInstruction.addEventListener('click', ()=> instructionModal.style.display = 'flex');
    if(closeInstruction) closeInstruction.addEventListener('click', ()=> instructionModal.style.display = 'none');
    if(instructionModal) instructionModal.addEventListener('click',(e)=>{ if(e.target===instructionModal) instructionModal.style.display='none'; });
  </script>

  <script>
   // æ›´æ–°å›¢é˜Ÿæ˜¾ç¤ºå‡½æ•°
function updateTeamDisplay() {
  const teamGrid = document.getElementById('teamGrid');
  if (!teamGrid) return;
  
  const ownedUpgrades = Object.values(upgrades).filter(u => u.owned);
  
  if (ownedUpgrades.length === 0) {
    teamGrid.innerHTML = `
      <div class="col-span-3 text-center py-6 text-gray-400">
        <span class="iconify inline-block text-4xl mb-2" data-icon="mdi:account-question"></span>
        <div class="text-sm">å°šæœªæ‹›å‹Ÿå›¢é˜Ÿæˆå‘˜</div>
        <div class="text-xs mt-1">å®Œæˆä¸€å¤©è¥ä¸šåå¯åœ¨å•†åº—æ‹›å‹Ÿ</div>
      </div>
    `;
    return;
  }
  
  // å›¢é˜Ÿæˆå‘˜å›¾ç‰‡æ˜ å°„
  const teamImages = {
    'tianyurong': 'tyr_sway.gif',
    'wanjiang': 'wj_sway.gif', 
    'cuiyuankao': 'cyk_sway.gif',
    'luoke': 'lk_sway.gif',
    'maoyuxia': 'myx_sway.gif'
  };
  
  teamGrid.innerHTML = ownedUpgrades.map(u => {
    const imageFile = teamImages[u.id] || 'default.png';
    return `
      <div class="team-member-card owned">
        <img src="${imageFile}" alt="${u.name}" class="team-member-image" 
             onerror="this.src='default.png'">
        <div class="team-member-name">${u.name}</div>
        <div class="team-member-desc">${u.desc}</div>
        <div class="team-member-skill text-xs text-green-600 font-bold mt-1">${u.skill}</div>
      </div>
    `;
  }).join('');
}

// åœ¨å…³é”®ä½ç½®è°ƒç”¨æ›´æ–°å‡½æ•°
// åœ¨ buyUpgrade å‡½æ•°ä¸­ï¼ˆå¤§çº¦ç¬¬ 750 è¡Œï¼‰æ·»åŠ ï¼š
window.buyUpgrade = function(id) {
    const u = upgrades[id];
    if(!u || u.owned || coins < u.price) return;
    
    coins -= u.price;
    u.owned = true;
    
    playMusic('game'); 
    toast(`ğŸ æˆåŠŸæ‹›å‹Ÿï¼š${u.name}`);
    updateShopUI();
    updateHUD();
    updateTeamDisplay(); // æ–°å¢è¿™è¡Œ
}

// åœ¨æ¸¸æˆé¡µé¢æ˜¾ç¤ºæ—¶ï¼ˆå¤§çº¦ç¬¬ 830 è¡Œï¼‰æ·»åŠ ï¼š
startGameBtn.addEventListener('click', ()=>{
    startPage.style.display = 'none';
    gamePage.style.display = 'block';
    endPage.style.display = 'none';
    shopPage.style.display = 'none';
    playMusic('game'); 
    setTimeout(()=>{ 
        initGrill(); 
        updateTeamDisplay(); // æ–°å¢è¿™è¡Œ
    }, 300);
    isShopOpen = false; 
     updateBusinessButtons();
    if(btnNextDay) btnNextDay.style.display = ""; 
    toast("ğŸ‘† è¯·ç‚¹å‡»ä¸Šæ–¹'å¼€å§‹è¥ä¸š'æŒ‰é’®");
});
</script>

</body>
</html>